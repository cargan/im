<html>
<body>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script>
jQuery(function(){
    var graph = new Springy.Graph();
    $.get('/data/map.json', function(result) {
        var nodes = {};
        result.nodes.forEach(function(val, key) {
            nodes[val] = graph.newNode({label: val});
        });

        result.edges.forEach(function(val, key) {
            graph.newEdge(
                nodes[val.from],
                nodes[val.to],
                {
                    color: Colors[key],
                    label: val.weight
                }
            );
        });

      var springy = window.springy = jQuery('#machines').springy({
        graph: graph,
        nodeSelected: function(node){
          console.log('Node selected: ' + JSON.stringify(node.data));
        }
      });

        machinesSummary(result.nodes);

    }, 'json');

    var machinesSummary = function (nodes) {
        $.get('/data/machines.json', function(result) {
            var ms = {};
            result.forEach(function(val, key) {
                if (ms[val.location] == undefined) {
                    ms[val.location] = {};
                }
                if (ms[val.location][val.machine] == undefined) {
                    ms[val.location][val.machine] = {
                        name: val.machine,
                        value: 0
                    };
                }
                ms[val.location][val.machine]['value']++;
            });
            for (m in ms) {
                var MAC = [];
                for (ma in ms[m]) {
                    MAC.push({
                        name: ms[m][ma].name,
                        value: ms[m][ma].value
                    });
                }

                ms[m]['machines'] = MAC;
            }
            var machines = [];
            nodes.forEach(function(val, key) {
                var items = ms[val] ? ms[val]['machines'] : [];
                machines.push({
                    node: val,
                    machines: items
                });
            });

            var template = $('#Mtemplate').html();
            Mustache.parse(template);
            var rendered = Mustache.render(template, {
                machines: machines
            });

          $('td#terrainObjects').html(rendered);

        }, 'json');
    }

});

</script>

<script id="Mtemplate" type="x-tmpl-mustache">
<table>
    <tr>
        <th>Position</th>
        <th>Objects</th>
    </tr>
    {{#machines}}
    <tr>
        <td>{{node}}</td>
        <td>
            {{#machines}}
            {{ name }} : {{ value }}
            {{/machines}}
            {{^machines}}-{{/machines}}
        </td>
    </tr>
    {{/machines}}
</table>
</script>

<div class="controls">
    <form>
        <div>
            <button id="addMachine">Add Machine</button>
            <button id="addKali">Add Kali</button>
            <button id="addEli">Add Eli</button>
            <button id="addEnemy">Add Enemy</button>
        </div>
        <div>
            <label for="Location">Location</label>
            <input type="text" name="Location" value="" id="Location">

            <label for="count">Count</label>
            <input type="text" name="count" value="" id="count">

        </div>
    </form>
</div>

<table width="100%" id="wrap">
    <tr>
        <td><canvas id="machines" width="1300" height="700" /></td>
        <td id="terrainObjects"></td>
    </tr>
</table>

<script src="/static/springy.js"></script>
<script src="/static/springyui.js"></script>
<script src="/static/colors.js"></script>
<script src="/static/mustache.js"></script>

</body>
</html>
