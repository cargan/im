<html>
<body>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script>
var API = '/api.php';
var MACHINES = [];
jQuery(function(){

    $('form#manipulateMachines').submit(function() {
        var data = {};
        data.location = $(this).find('#Location').val();
        data.count = $(this).find('#count').val();
        data.machine = $(this).find('#addMachine').val();
        addMachine(data);
        return false;
    })

    var addMachine = function(data) {
        var postData = {
            a: 'addMachine',
            location: data.location,
            count: data.count,
            machine: data.machine
        };

        $.post(API, postData, function(result) {
            console.log(result);
        });
    };

    var drawMap = function(graph) {
        var data = {
            a: 'getNodesAndEdges'
        };

        $.get(API, data, function(response) {
            var nodes = {};
            response.result.nodes.forEach(function(val, key) {
                nodes[val.node] = graph.newNode({label: val.node});
            });

            response.result.edges.forEach(function(val, key) {
                graph.newEdge(
                    nodes[val.nfrom],
                    nodes[val.nto],
                    {
                        color: Colors[key],
                        label: val.weight
                    }
                );
            });

          var springy = window.springy = jQuery('#machines').springy({
            graph: graph,
            nodeSelected: function(node){
              console.log('Node selected: ' + JSON.stringify(node.data));
            }
          });

            machinesSummary(response.result.nodes);
            enemiesSummary(response.result.nodes);

        }, 'json');
    };

    var machinesSummary = function (nodes) {
        var data = {
            a: 'getMachines'
        };

        $.post(API, data, function(response) {
            var MACHINES = response.result;
            var mach = {};
            response.result.forEach(function(val, key) {
                if (typeof mach[val.node] === "undefined") {
                    mach[val.node] =[];
                }
                mach[val.node].push({
                    name: val.name,
                    value: val.mcount
                });
            });

            var machines = [];
            nodes.forEach(function(val, key) {
                var M = [];
                if (typeof mach[val.node] !== "undefined") {
                    M = mach[val.node];
                }
                machines.push({
                    node: val.node,
                    machines: M
                });

            });

            var template = $('#Mtemplate').html();
            Mustache.parse(template);
            var rendered = Mustache.render(template, {
                machines: machines
            });

          $('td#terrainObjectsMachines').html(rendered);

        }, 'json');
    }


    var enemiesSummary = function (nodes) {
        var data = {
            a: 'getEnemies'
        };

        $.post(API, data, function(response) {
            var MACHINES = response.result;
            var mach = {};
            response.result.forEach(function(val, key) {
                if (typeof mach[val.node] === "undefined") {
                    mach[val.node] =[];
                }
                mach[val.node].push({
                    name: val.name,
                    value: val.mcount
                });
            });

            var machines = [];
            nodes.forEach(function(val, key) {
                var M = [];
                if (typeof mach[val.node] !== "undefined") {
                    M = mach[val.node];
                }
                machines.push({
                    node: val.node,
                    machines: M
                });

            });



            var template = $('#Mtemplate').html();
            Mustache.parse(template);
            var rendered = Mustache.render(template, {
                machines: enemies
            });

          $('td#terrainObjectsEnemies').html(rendered);

        }, 'json');
    }


    var graph = new Springy.Graph();
    drawMap(graph);
});

</script>

<script id="Mtemplate" type="x-tmpl-mustache">
<table>
    <tr>
        <th>Position</th>
        <th>Objects</th>
    </tr>
    {{#machines}}
    <tr>
        <td>{{node}}</td>
        <td>
            {{#machines}}
            {{ name }} : {{ value }}
            {{/machines}}
            {{^machines}}-{{/machines}}
        </td>
    </tr>
    {{/machines}}
</table>
</script>

<div class="controls">
    <form id="manipulateMachines">
        <div>
            <label for="Location">Location</label>
            <input type="text" name="Location" value="" id="Location">

            <label for="count">Count</label>
            <input type="text" name="count" value="" id="count">

            <select id="addMachine">
                <option></option>
                <option value="3">Machine</option>
                <option value="1">Kali</option>
                <option value="2">Eli</option>
                <option value="4">Enemy</option>
            </select>

            <button>Add</button>
        </div>
    </form>
</div>

<table width="100%" id="wrap">
    <tr>
        <td><canvas id="machines" width="1300" height="700" /></td>
        <td id="terrainObjectsMachines"></td>
        <td id="terrainObjectsEnemies"></td>
    </tr>
</table>

<script src="/static/springy.js"></script>
<script src="/static/springyui.js"></script>
<script src="/static/colors.js"></script>
<script src="/static/mustache.js"></script>

</body>
</html>
